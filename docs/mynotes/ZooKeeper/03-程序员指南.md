# 03-程序员指南

[TOC]

## 介绍

> 该文档包含：**概念**和**实践**信息。为希望创建利用 ZooKeeper 协调服务的分布式应用程序的开发人员提供的指南

概念讨论

- [ZooKeeper 数据模型](#model)
- [ZooKeeper 会话](#session)
- [ZooKeeper 监视](#watches)
- [一致性保障](#consistency)

实用的编程信息

- [构建块：ZooKeeper 操作指南](#building_block)
- [绑定](#binding)
- [陷阱：常见问题和故障排除](#notes)

## <a id = 'model'></a>ZooKeeper 数据模型

ZooKeeper 有一个分层命名空间，很像分布式文件系统。唯一的区别是命名空间中的每个节点都可以有与其关联的数据以及子节点

- 空字符 (`\u0000`) 不能是路径名的一部分。（会导致` C` 绑定出现问题）
- 不能使用以下字符，因为它们显示不好，或呈现方式混乱：`\u0001` -` \u001F` 和 `\u007F`、`\u009F`
- 不允许使用以下字符：`\ud800` - `uF8FF`、`\uFFF0` - `\uFFFF`
- ”。” 字符可以用作另一个名称的一部分，但`.` 并且`..`不能单独用于指示路径上的节点，因为`ZooKeeper`不使用相对路径。以下内容无效：`/a/b/./c`或`/a/b/../c`
- `zookeeper`是保留目录。

### Znode

Znode 维护一个 stat 结构，包括数据更改的版本号、acl 更改。stat 结构也有时间戳。版本号与时间戳一起允许 ZooKeeper 验证缓存并协调更新。更新一次版本增加，更新携带版本号，版本不一致则会更新失败

节点可以指：主机、服务器、集成成员、客户端进程等

**特点：**

- **`Watches`：**对该`znode`的更改会触发监视，然后清除监视。当`watch`触发时，`ZooKeeper`会向客户端发送通知，更多信息，请参阅[ZooKeeper 监视](#watches)部分。
- **数据访问：** **原子读取和写入**，每个节点都有一个访问控制列表 (`ACL`)，它限制谁可以做什么
- **临时节点：**随着创建该`znode`的会话的覆灭而删除，可以使用**`getEphemerals()`** api 检索会话的临时列表
- **序列节点——唯一命名：**创建`znode`时，可以请求` ZooKeeper` 在路径末尾附加一个单调递增的计数器，当递增超过 `2147483647` 时，计数器将溢出
- **容器节点（3.6.0）：**容器`znode`是特殊用途的`znode`，可用于诸如领导者、锁等。容器的最后一个子节点被删除时，该`znode`也将会被删除
- **`TTL` 节点（3.6.0）：**有过期时间的节点，过期后删除此节点

### ZooKeeper 中的时机

- **`Zxid`** - 每个更改都会有一个唯一的 `zxid`，如果 `zxid1` 小于` zxid2`，则 `zxid1` 发生在 `zxid2` 之前
- **版本号** - 每次更改都会导致该节点的版本号增加。三个版本号分别是`version`（`znode`的数据变化次数）、`cversion`（`znode`子节点的变化次数）和`aversion`（`znode`的`ACL`变化次数）
- **`tick`** - 服务器使用 `ticks` 来定义事件的时间，例如状态上传、会话超时、对等点之间的连接超时等
- **实时** - 几乎不用，除了在` znode` 创建和 `znode` 修改时将时间戳放入 stat 结构中

### ZooKeeper 的`stat`结构

- **`cZxid`：** 创建时生成的关联的`zxid`
- **`mZxid`：** 最后修改此`znode`时生成的关联的`zxid`
- **`pZxid`：** 最后修改的子节点的 `czxid`
- **`ctime`：**创建此`znode`时的时间
- **`mtime`：**修改此`znode`时的时间
- **`version`：**此 `znode` 的数据更改次数。
- **`cversion`：**此 `znode` 的子节点的更改次数。
- **`aversion`：**此 `znode` 的 `ACL` 的更改次数。
- **`ephemeralOwner`：**如果 znode 是临时节点，则该 znode 所有者的会话 id。如果它不是临时节点，它将为零。
- **`dataLength`：**此 `znode` 的数据字段的长度。
- **`numChildren`：**此 `znode` 的子节点数。

```shell
[zk: 127.0.0.1:2181(CONNECTED) 8] stat /zk_test
cZxid = 0x8  # 创建时生成
ctime = Sun Sep 25 16:59:30 UTC 2022 # 创建时间
mZxid = 0x9 # 修改时生成
mtime = Sun Sep 25 17:00:36 UTC 2022 # 修改时间
pZxid = 0x8 # 最后修改的子节点的 cZxid
cversion = 0 # 孩子节点更改次数
dataVersion = 1 # 本节点更改次数
aclVersion = 0 # 访问控制列表的更改次数
ephemeralOwner = 0x0 # 临时节点的 session id，默认为 0
dataLength = 4 # 本节点数据长度
numChildren = 0 # 孩子节点数
[zk: 127.0.0.1:2181(CONNECTED) 9] set /zk_test junk1
[zk: 127.0.0.1:2181(CONNECTED) 11] stat /zk_test
cZxid = 0x8
ctime = Sun Sep 25 16:59:30 UTC 2022
mZxid = 0xa
mtime = Sun Sep 25 17:02:26 UTC 2022
pZxid = 0x8
cversion = 0
dataVersion = 2
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 5
numChildren = 0
[zk: 127.0.0.1:2181(CONNECTED) 12] 
```

## <a id = 'session'></a>ZooKeeper 会话

ZooKeeper 客户端通过使用（Java｜C）**语言绑定**创建服务句柄来与 ZooKeeper 服务**建立会话**

会话创建后以**`CONNECTING`**开始，连接到任何`ZooKeeper`服务器之一，切换到 **`CONNECTED`** 状态，遇到任何不可恢复错误，变为**`CLOSE`**状态

![state_dia](https://zookeeper.apache.org/doc/current/images/state_dia.jpg)

### 会话建立

客户端代码中提供字符串：“127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002”

客户端将选择任意一个服务器进行连接，连接失败的话，就会自动尝试列表中的下一个服务器

**3.2.0中**

> 一个可选的“chroot”后缀也可以附加到连接字符串中，**我理解：即环境前缀**

**例如：**“127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002/app/a”，客户端将在"/app/a" 并且所有路径都相对于这个根目录进行操作 \- 即获取/设置/etc... "/foo/bar" 将导致在 "/app/a/foo/bar" 上运行操作（来自服务器视角）

**多租户环境中特别有用，每个用户都有自己的根路径就好像在“/”上一样**

### 分布式会话的安全措施

当客户端获得 ZooKeeper 服务的句柄时，服务器会创建一个64位数字的会话id，并将会话id的密码告知其他服务器，然后将会话id与密码一并返回给客户端

### 会话超时参数

> 在建立连接时的客户端参数中，以毫秒为单位，当前的实现要求超时时间至少为 tickTime 的 2 倍（在服务器配置中设置），最大为 tickTime 的 20 倍

会话过期由ZK集群管理，而非客户端，客户端带上超时时间参数，当服务器判断超时后，会删除所有相关会话的临时节点，并将状态变更做为事件，通知监视这些事件的其他客户端

### 默认观察者参数

> 当客户端发生任何状态更改时，会通知观察者，这个观察者初始状态是断开的



## <a id = 'watches'></a>ZooKeeper 监视

## ZooKeeper 使用 ACL 进行访问控制

## 可插拔 ZooKeeper 身份验证

## <a id = 'consistency'></a>一致性保障

## <a id = 'binding'></a>绑定

## <a id = 'building_block'></a>构建块：ZooKeeper 操作指南

## <a id = 'notes'></a>陷阱：常见问题和故障排除



本指南的前四个部分对各种 ZooKeeper 概念进行了更高层次的讨论，