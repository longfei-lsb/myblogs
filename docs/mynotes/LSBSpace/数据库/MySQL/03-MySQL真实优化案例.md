## 网评项目优化

有一次政府网站的网评模块并发导致整个网站卡死不能用的问题，之前都已经打算放弃了我们的合作了。

当时经过协调客户反馈与沟通，才知道我们需要在一个小时之内支持30多万个网评事务量，程序方面是比较简单一些的，于是就断定一定是需要在SQL服务上做一些优化，当时是我自己做好的这个程序嘛，也是刚好在看一本SQL存储引擎这本书，主动请缨，就落在了我头上。

我没优化之前呢，

我们当时也没有什么主从复制之类的备份功能

程序就是网评之前插入一些数据信息（网评服务端要我们维护网评id并给到他们，所以必须插入数据），网评之后实时更新数据记录的方式

表就是那种常规思路去设计的那一张表：

**UUID作为的主键也没有多想**

**网评的相关信息和网评成功返回评论信息（用户、标识符、评论、文章id、评论时间），也都是在一张表中**

起初肯定是优先考虑自己这边做一些优化，

**考虑到插入数据时的UUID的页分裂问题**

我就新建了一张表，不过不是UUID做主键了，将UUID那一列，作为了一个备份id，去保持与网评服务端的id关系，**新加了一个自增id的形式**

**又怕自增锁会影响到插入的效率**

就修改了数据库服务的自增锁配置变量`innodb_autoinc_lock_mode` =  2，不让它锁表，来提高并发性能

**又担心网评成功之后的数据记录影响增大插入后数据库的访问压力**

因为更新数据记录也会消耗额外的数据库连接嘛，所以不希望消耗，

就在程序处理成功后，利用redis先将数据记录暂时存储，开启一个定时任务批量到更新到数据库中

**改进之后，起初良好了挺多，但是的话还是会有卡顿**

之后又决定和网评服务端商量，以及客户端的一些优化，不采用实时信息展示，采用刷新延时展示的方式进行网评成功记录信息

取消掉了redis的存放，改为异步接收消息来处理。

之后也是因为表现良好，涨了不少薪资。